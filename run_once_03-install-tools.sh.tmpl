#!/usr/bin/env bash

set -euo pipefail

# Install all tools using priority: mise > cargo > brew > uv > apt-get

echo "Installing tools..."

export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

# --- System packages (things mise can't install) ---

{{- if eq .chezmoi.os "darwin" }}

if command -v brew &>/dev/null; then
    if [[ $(arch) == "arm64" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ $(arch) == "i386" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    echo "Installing system packages via Homebrew..."
    brew install fish gnupg curl wget htop tree
else
    echo "Warning: Homebrew not found, skipping system packages"
fi

{{- end }}

{{- if eq .chezmoi.os "linux" }}

echo "Installing system packages via apt-get..."
if command -v apt-get &>/dev/null; then
    sudo apt-get update -qq
    sudo apt-get install -y \
        fish \
        build-essential \
        curl \
        wget \
        htop \
        tree \
        unzip \
        gnupg \
        git
else
    echo "Warning: apt-get not found, skipping system packages"
fi

{{- end }}

# --- mise tools (the primary source of truth) ---

if command -v mise &>/dev/null; then
    echo "Installing tools via mise..."
    mise install --yes
    echo "mise tools installed"
else
    echo "Warning: mise not found, skipping mise tools"
fi

echo "Tools installation complete"
