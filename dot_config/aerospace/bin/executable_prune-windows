#!/usr/bin/env bash
set -euo pipefail

DRY_RUN=false # set to false to actually close windows

focused=$(aerospace list-windows --focused --format '%{window-id}' 2>/dev/null || echo "")

aerospace list-windows --all --format $'%{window-id}\t%{app-name}\t%{window-title}\t%{app-pid}%{newline}' |
  while IFS=$'\t' read -r wid app title pid; do
    echo "DEBUG: DRY_RUN=$DRY_RUN wid=$wid"
    [ -z "${wid:-}" ] && continue

    if [ "$wid" = "$focused" ]; then
      echo "Skipping focused window $wid ($app - ${title:-<no title>})"
      continue
    fi

    # Query live window names for this app (comma-separated list)
    js="$(
      osascript -e "tell application \"System Events\"
      try
        if not (exists process \"$app\") then return \"__NO_PROC__\"
        set W to name of every window of process \"$app\"
        if (count of W) = 0 then return \"__EMPTY_LIST__\"
        return W as string
      on error err
        return \"__ERR__\" & err
      end try
    end tell"
    )" || js="__ERR__"

    if [[ "$js" == __ERR__* ]]; then
      echo "System Events failed for $app â€” skipping to be safe."
      continue
    fi

    # Split comma-separated window list into array safely
    IFS=',' read -r -a live_titles <<<"$js"
    # trim whitespace in-place
    for i in "${!live_titles[@]}"; do
      live_titles[$i]="$(echo "${live_titles[$i]}" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
    done

    # If there are no live windows at all, mark as stale
    if [ "${#live_titles[@]}" -eq 0 ] || [ "${live_titles[0]}" = "__EMPTY_LIST__" ]; then
      echo "[DRY-RUN] Would remove stale window id=$wid app='$app' (no live windows)"
      continue
    fi

    # Substring matching (case-sensitive, safer)
    matched=false
    for lt in "${live_titles[@]}"; do
      if [[ "$lt" == *"$title"* ]] || [[ "$title" == *"$lt"* ]]; then
        matched=true
        break
      fi
    done

    if [ "$matched" = true ]; then
      echo "Keeping window id=$wid ($app - $title)"
    else
      if [ "$DRY_RUN" = true ]; then
        echo "[DRY-RUN] Would remove stale window id=$wid app='$app' title='$title' (no match among: ${live_titles[*]})"
      else
        echo "Removing stale window id=$wid app='$app' title='$title'"
        aerospace close --window-id "$wid" || echo "  -> aerospace close failed for $wid"
      fi
    fi
  done
