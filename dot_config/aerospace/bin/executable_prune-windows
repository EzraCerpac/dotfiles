#!/usr/bin/env bash
# prune-windows: remove ghost/stale windows from AeroSpace
set -uo pipefail # no -e; we handle errors ourselves

# toggle dry-run behavior (or run with DRY_RUN=true ./prune-windows)
DRY_RUN=${DRY_RUN:-false}
export DRY_RUN

# how long to pause between closes
CLOSE_DELAY=0.06

# list of stale window ids to close
declare -a STALE_IDS=()

# get focused window (never close it)
focused=$(aerospace list-windows --focused --format '%{window-id}' 2>/dev/null || echo "")

# === 1️⃣  DETECTION PASS =======================================================
while IFS=$'\t' read -r wid app title pid; do
  [ -z "${wid:-}" ] && continue

  if [ "$wid" = "$focused" ]; then
    echo "Skipping focused window $wid ($app - ${title:-<no title>})"
    continue
  fi

  js="$(
    osascript -e "tell application \"System Events\"
      try
        if not (exists process \"$app\") then return \"__NO_PROC__\"
        set W to name of every window of process \"$app\"
        if (count of W) = 0 then return \"__EMPTY_LIST__\"
        return W as string
      on error err
        return \"__ERR__\" & err
      end try
    end tell"
  )" || js="__ERR__"

  if [[ "$js" == __ERR__* ]]; then
    echo "System Events failed for $app — skipping to be safe."
    continue
  fi

  IFS=',' read -r -a live_titles <<<"$js"
  for i in "${!live_titles[@]}"; do
    live_titles[$i]="$(printf '%s' "${live_titles[$i]}" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
  done

  matched=false
  if [ "${#live_titles[@]}" -eq 0 ] || [ "${live_titles[0]}" = "__EMPTY_LIST__" ]; then
    matched=false
  else
    for lt in "${live_titles[@]}"; do
      # substring both directions
      if [[ "$lt" == *"$title"* ]] || [[ "$title" == *"$lt"* ]]; then
        matched=true
        break
      fi
    done
  fi

  if [ "$matched" = true ]; then
    echo "Keeping window id=$wid ($app - $title)"
  else
    echo "[FOUND STALE] id=$wid app='$app' title='$title'"
    STALE_IDS+=("$wid")
  fi
done < <(aerospace list-windows --all --format $'%{window-id}\t%{app-name}\t%{window-title}\t%{app-pid}%{newline}')

# === 2️⃣  CLEANUP PASS ==========================================================
if [ "${#STALE_IDS[@]}" -eq 0 ]; then
  echo "No stale windows found."
  exit 0
fi

echo
echo "→ Found ${#STALE_IDS[@]} stale windows: ${STALE_IDS[*]}"
if [ "$DRY_RUN" = true ]; then
  echo "Dry-run mode: nothing will be closed."
  exit 0
fi

for wid in "${STALE_IDS[@]}"; do
  echo "Closing stale window id=$wid"
  if ! aerospace close --window-id "$wid"; then
    echo "  ⚠️  close failed for $wid (may already be gone)"
  fi
  sleep "$CLOSE_DELAY"
done

echo "✅ Done pruning stale windows."
