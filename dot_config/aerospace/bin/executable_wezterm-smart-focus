#!/usr/bin/env bash
set -euo pipefail

direction="${1:-}"
if [[ -z "${direction}" ]]; then
    echo "usage: wezterm-smart-focus <left|right|up|down>" >&2
    exit 2
fi

is_wezterm_focused() {
    local app lower
    app=$(aerospace list-windows --focused --format "%{app-name}" 2>/dev/null || true)
    lower=$(printf '%s' "$app" | tr '[:upper:]' '[:lower:]')
    [[ "$lower" == *"wezterm"* ]]
}

fallback_to_aerospace() {
    "${AEROSPACE_CLI:-aerospace}" focus --boundaries all-monitors-outer-frame "${direction}" || true
}

main() {
    # Resolve CLIs for GUI contexts with limited PATH (AeroSpace)
    if command -v wezterm >/dev/null 2>&1; then
        WEZTERM_CLI=$(command -v wezterm)
    elif [[ -x "/opt/homebrew/bin/wezterm" ]]; then
        WEZTERM_CLI="/opt/homebrew/bin/wezterm"
    else
        WEZTERM_CLI=""
    fi

    if command -v aerospace >/dev/null 2>&1; then
        AEROSPACE_CLI=$(command -v aerospace)
    elif [[ -x "/opt/homebrew/bin/aerospace" ]]; then
        AEROSPACE_CLI="/opt/homebrew/bin/aerospace"
    else
        AEROSPACE_CLI="aerospace"
    fi

    if [[ -z "${WEZTERM_CLI}" ]]; then
        fallback_to_aerospace
        exit 0
    fi

    if is_wezterm_focused; then
        # Try targeting the most recently interacted WezTerm client.
        if "${WEZTERM_CLI}" cli set-user-var AEROSPACE_FOCUS "${direction}"; then
            exit 0
        fi
    fi

    fallback_to_aerospace
}

main "$@"
