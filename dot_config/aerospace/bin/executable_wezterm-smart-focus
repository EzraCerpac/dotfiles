#!/usr/bin/env bash
set -euo pipefail

direction="${1:-}"
if [[ -z "${direction}" ]]; then
    echo "usage: wezterm-smart-focus <left|right|up|down>" >&2
    exit 2
fi

is_wezterm_focused() {
    local app lower
    app=$(aerospace list-windows --focused --format "%{app-name}" 2>/dev/null || true)
    lower=$(printf '%s' "$app" | tr '[:upper:]' '[:lower:]')
    [[ "$lower" == *"wezterm"* ]]
}

fallback_to_aerospace() {
    "${AEROSPACE_CLI:-aerospace}" focus --boundaries all-monitors-outer-frame "${direction}" || true
}

main() {
    # Resolve CLIs for GUI contexts with limited PATH (AeroSpace)
    if command -v wezterm >/dev/null 2>&1; then
        WEZTERM_CLI=$(command -v wezterm)
    elif [[ -x "/opt/homebrew/bin/wezterm" ]]; then
        WEZTERM_CLI="/opt/homebrew/bin/wezterm"
    else
        WEZTERM_CLI=""
    fi

    if command -v aerospace >/dev/null 2>&1; then
        AEROSPACE_CLI=$(command -v aerospace)
    elif [[ -x "/opt/homebrew/bin/aerospace" ]]; then
        AEROSPACE_CLI="/opt/homebrew/bin/aerospace"
    else
        AEROSPACE_CLI="aerospace"
    fi

    if [[ -z "${WEZTERM_CLI}" ]]; then
        fallback_to_aerospace
        exit 0
    fi

    if is_wezterm_focused; then
        # Ensure we can talk to a running WezTerm instance
        if ! "${WEZTERM_CLI}" cli list-clients >/dev/null 2>&1; then
            fallback_to_aerospace
            exit 0
        fi

        # Send OSC 1337 SetUserVar=AEROSPACE_FOCUS=<b64(dir)> to the active pane.
        # WezTerm's user-var-changed handler will: if Neovim, send Alt-h/j/k/l;
        # else, move to a pane in that direction; else, delegate to AeroSpace.
        b64=$(printf %s "$direction" | base64 | tr -d '\n')
        osc=$(printf '\033]1337;SetUserVar=%s=%s\007' "AEROSPACE_FOCUS" "$b64")
        if "${WEZTERM_CLI}" cli send-text --no-paste -- "$osc" >/dev/null 2>&1; then
            exit 0
        fi
    fi

    fallback_to_aerospace
}

main "$@"
