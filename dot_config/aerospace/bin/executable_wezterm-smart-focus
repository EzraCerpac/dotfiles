#!/usr/bin/env bash
set -euo pipefail

direction="${1:-}"
if [[ -z "${direction}" ]]; then
  echo "usage: wezterm-smart-focus <left|right|up|down>" >&2
  exit 2
fi

direction_lower=$(printf '%s' "${direction}" | tr '[:upper:]' '[:lower:]')
case "${direction_lower}" in
  left|right|up|down) ;;
  *)
    echo "wezterm-smart-focus: unsupported direction '${direction}'" >&2
    exit 2
    ;;
esac

is_wezterm_focused() {
  local app lower
  app=$(aerospace list-windows --focused --format "%{app-name}" 2>/dev/null || true)
  lower=$(printf '%s' "$app" | tr '[:upper:]' '[:lower:]')
  [[ "$lower" == *"wezterm"* ]]
}

fallback_to_aerospace() {
  "${AEROSPACE_CLI:-aerospace}" focus --boundaries all-monitors-outer-frame "${direction}" || true
}

encode_base64() {
  printf '%s' "$1" | base64 | tr -d '\n'
}

send_user_var() {
  local pane_id="$1"
  local tty_name="$2"
  local payload osc

  payload=$(encode_base64 "${direction_lower}")
  osc=$'\033]1337;SetUserVar=ActivatePaneFromAerospace='"${payload}"$'\007'

  if [[ -n "${tty_name}" && -w "${tty_name}" ]]; then
    if printf '%s' "${osc}" >"${tty_name}"; then
      return 0
    fi
  fi

  if [[ -n "${pane_id}" ]]; then
    if printf '%s' "${osc}" | "${WEZTERM_CLI}" cli send-text --pane-id "${pane_id}" --no-paste >/dev/null 2>&1; then
      return 0
    fi
  fi

  return 1
}

main() {
  # Resolve CLIs for GUI contexts with limited PATH (AeroSpace)
  if command -v wezterm >/dev/null 2>&1; then
    WEZTERM_CLI=$(command -v wezterm)
  elif [[ -x "/opt/homebrew/bin/wezterm" ]]; then
    WEZTERM_CLI="/opt/homebrew/bin/wezterm"
  else
    WEZTERM_CLI=""
  fi

  if command -v aerospace >/dev/null 2>&1; then
    AEROSPACE_CLI=$(command -v aerospace)
  elif [[ -x "/opt/homebrew/bin/aerospace" ]]; then
    AEROSPACE_CLI="/opt/homebrew/bin/aerospace"
  else
    AEROSPACE_CLI="aerospace"
  fi

  if [[ -z "${WEZTERM_CLI}" ]]; then
    fallback_to_aerospace
    exit 0
  fi

  if is_wezterm_focused; then
    # Ensure we can talk to a running WezTerm instance
    if ! "${WEZTERM_CLI}" cli list-clients >/dev/null 2>&1; then
      fallback_to_aerospace
      exit 0
    fi

    local focused_pane_id
    focused_pane_id=$("${WEZTERM_CLI}" cli list-clients --format json 2>/dev/null \
      | jq -r 'map(select(.focused_pane_id != null)) | first | .focused_pane_id // empty' 2>/dev/null || true)

    if [[ -n "${focused_pane_id}" ]]; then
      local focused_tty
      focused_tty=$("${WEZTERM_CLI}" cli list --format json 2>/dev/null \
        | jq -r --arg id "${focused_pane_id}" '.[] | select((.pane_id|tostring) == $id) | .tty_name' \
        | head -n1 2>/dev/null || true)

      if send_user_var "${focused_pane_id}" "${focused_tty}"; then
        exit 0
      fi
    fi
  fi

  fallback_to_aerospace
}

main "$@"
